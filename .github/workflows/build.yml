name: Build and Test
on: push

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      MCP_TOKEN: ${{ secrets.MCP_TOKEN }}
      PLAYWRIGHT_TOKEN: ${{ secrets.PLAYWRIGHT_TOKEN }}
    strategy:
      fail-fast: false
      matrix:
        java-version: [ 24, 25-ea ]
    steps:
      - name: Debug token presence
        run: |
          echo "GITHUB_TOKEN length: $(echo $GITHUB_TOKEN | wc -c)"
          echo "MCP_TOKEN length: $(echo $MCP_TOKEN | wc -c)"
          echo "PLAYWRIGHT_TOKEN length: $(echo $PLAYWRIGHT_TOKEN | wc -c)"
          
      - name: Set up environment
        run: |
          echo "Setting up build environment"
          echo "JAVA_VERSION=${{ matrix.java-version }}" >> $GITHUB_ENV
          echo "Setting up Maven options for potential firewall constraints"
          echo "MAVEN_OPTS=-Dmaven.wagon.http.retryHandler.requestSentEnabled=true -Dmaven.wagon.http.retryHandler.count=3" >> $GITHUB_ENV

      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
      - name: Cache Maven artifacts
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Cache node
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node_modules-
      - name: Build ${{ matrix.java-version }}
        run: mvn -B clean test

